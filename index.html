<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>areyoucoming.to</title>
  <style>
    :root{
      --bg:#070a11;--panel:#0d1220;--panel2:#0b1020;--text:#e8ecf5;--muted:#9aa6bd;--border:#1b2640;
      --yes:#22c55e;--no:#ef4444;--wait:#fbbf24;--link:#7dd3fc;--shadow: rgba(0,0,0,.45);
      --ring: rgba(125, 211, 252, .35);
      --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 500px at 50% -180px, #162349 0%, rgba(7,10,17,0) 70%),
        radial-gradient(700px 400px at 12% 30%, rgba(34,197,94,.10) 0%, rgba(7,10,17,0) 55%),
        radial-gradient(700px 400px at 88% 65%, rgba(239,68,68,.08) 0%, rgba(7,10,17,0) 55%),
        var(--bg);
      color:var(--text); padding:18px;
      display:flex; align-items:center; justify-content:center;
    }
    .wrap{width:min(980px,100%)}
    .card{background:linear-gradient(180deg,var(--panel2),var(--panel));border:1px solid var(--border);border-radius:18px;box-shadow:0 24px 70px var(--shadow);overflow:hidden}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:18px 22px;border-bottom:1px solid rgba(27,38,64,.7)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:10px;height:10px;border-radius:50%;background:#7dd3fc;box-shadow:0 0 12px rgba(125,211,252,.6)}
    .nav a{color:var(--link);text-decoration:none;font-size:.85rem;margin-left:12px;transition:opacity .2s}
    .nav a:hover{text-decoration:underline;opacity:0.8}
    .view{display:none; animation: fadeIn .4s var(--ease)}
    .view.active{display:block}

    @keyframes fadeIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }
    @keyframes pulse { 0% { transform:scale(1); } 50% { transform:scale(1.02); } 100% { transform:scale(1); } }
    @keyframes flyOutRight { to { transform: translate(150%, 10deg) rotate(20deg); opacity: 0; } }
    @keyframes flyOutLeft { to { transform: translate(-150%, 10deg) rotate(-20deg); opacity: 0; } }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* Invitee */
    .invitee{padding:28px 22px 32px; display:flex; flex-direction:column; min-height:400px}
    
    .name{margin-bottom:20px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; z-index: 10; position:relative}
    .name input{flex:1; min-width:220px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0b1020; color:var(--text); font-size:1rem; transition:border-color .2s}
    .name input:focus{border-color:var(--link); outline:none}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border-radius:999px; background:rgba(15,25,50,.7); border:1px solid rgba(27,38,64,.7); color:var(--muted); font-size:.82rem}
    .chip b{color:var(--text)}

    /* Swipe Stack */
    .card-stack { position: relative; width: 100%; flex: 1; display: flex; align-items: center; justify-content: center; min-height: 240px; }
    .swipe-card {
      position: relative; width: 100%; background: linear-gradient(180deg, rgba(20,26,45,0.6), rgba(13,18,32,0.4));
      border: 1px solid rgba(27,38,64,0.6); border-radius: 20px; padding: 24px;
      text-align: center; cursor: grab; touch-action: none; user-select: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transform-origin: 50% 100%;
      will-change: transform;
    }
    .swipe-card:active { cursor: grabbing; }
    .swipe-card.animating { transition: transform 0.3s var(--ease), opacity 0.3s; }
    
    .overlay {
      position: absolute; top: 20px; padding: 8px 16px; border: 4px solid; border-radius: 8px;
      font-weight: 800; font-size: 2rem; text-transform: uppercase; letter-spacing: 2px;
      opacity: 0; transform: rotate(-15deg); pointer-events: none; z-index: 10;
    }
    .yes-overlay { left: 20px; color: var(--yes); border-color: var(--yes); transform: rotate(-15deg); }
    .no-overlay { right: 20px; color: var(--no); border-color: var(--no); transform: rotate(15deg); }

    .swipe-card h1{margin:0 0 10px; font-size:1.6rem; letter-spacing:-.25px; pointer-events:none}
    .swipe-card .subtitle{color:var(--muted); margin-bottom:24px; pointer-events:none}
    
    .actions{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    button{appearance:none; border:0; border-radius:14px; padding:16px; font-weight:700; font-size:1rem; cursor:pointer; transition:transform .1s, filter .2s; z-index: 5}
    button:hover{filter:brightness(1.1)}
    button:active{transform:scale(0.98)}
    button:focus{outline:none; box-shadow:0 0 0 4px var(--ring)}
    .yes{background:linear-gradient(180deg,#25d366,#16a34a); color:#062d16}
    .no{background:linear-gradient(180deg,#ff5a5a,#dc2626); color:#3b0a0a}
    
    .status{margin-top:16px; color:var(--muted); min-height:1.4em; font-weight:500; display:flex; align-items:center; justify-content:center; gap:6px}
    .status.saved{color:var(--yes); animation: pulse .3s var(--ease)}

    /* Organiser */
    .org{padding:0}
    .event-top{padding:20px 22px;border-bottom:1px solid rgba(27,38,64,.7);display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:18px 22px}
    .stat{border:1px solid var(--border);border-radius:14px;padding:14px;background:rgba(15,25,50,.5);text-align:center}
    .stat b{font-size:1.6rem;display:block;margin-bottom:4px}
    .stat span{font-size:.85rem;color:var(--muted)}
    
table{width:100%;border-collapse:collapse}
    th,td{padding:12px 22px;font-size:.9rem;border-top:1px solid rgba(27,38,64,.6)}
    th{color:var(--muted);text-align:left;font-weight:600;font-size:.8rem;text-transform:uppercase;letter-spacing:0.5px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:500}
    .pill.y{background:rgba(34,197,94,.15);color:var(--yes)}
    .pill.n{background:rgba(239,68,68,.15);color:var(--no)}
    .pill.w{background:rgba(251,191,36,.15);color:var(--wait)}

    .panel{padding:24px 22px;border-top:1px solid rgba(27,38,64,.6);display:grid;grid-template-columns: 1fr 1fr;gap:24px;background:rgba(13, 18, 32, 0.4)}
    .panel h2{margin:0 0 8px;font-size:1rem}
    .panel .hint{color:var(--muted);font-size:.85rem;line-height:1.5}

    textarea{width:100%;min-height:86px;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b1020;color:var(--text);resize:vertical;font-family:inherit;line-height:1.4}
    textarea:focus{border-color:var(--link);outline:none}
    
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .btnSmall{border:1px solid var(--border);background:rgba(15,25,50,.7);color:var(--text);padding:8px 14px;border-radius:10px;font-size:.85rem;cursor:pointer;transition:background .2s}
    .btnSmall:hover{background:rgba(27,38,64,.8)}

    .linksBox{border:1px solid rgba(27,38,64,.7);background:rgba(15,25,50,.35);border-radius:12px;padding:12px}
    .linksBox code{display:block;color:var(--text);font-size:.85rem;word-break:break-all;line-height:1.4;font-family:ui-monospace, monospace}
    
    .empty-state{padding:32px;text-align:center;color:var(--muted);font-style:italic}

    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:rgba(17,24,39,.95);border:1px solid rgba(27,38,64,.8);color:var(--text);padding:10px 16px;border-radius:99px;box-shadow:0 14px 40px rgba(0,0,0,.4);display:none;font-size:.9rem;z-index:99}

    @media(max-width:900px){.panel{grid-template-columns:1fr}}
    @media(max-width:640px){.actions{grid-template-columns:1fr}.stats{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="brand"><span class="dot"></span><span id="brand">areyoucoming.to</span></div>
        <div class="nav">
          <a href="#" id="navInvitee">Invitee</a>
          <a href="#" id="navOrg">Organiser</a>
        </div>
      </header>

      <!-- INVITEE VIEW -->
      <section class="view invitee active" id="inviteeView">
        <div class="name">
          <input id="nameInput" placeholder="Your name (shown to organiser)" autocomplete="off" />
          <span class="chip" id="inviteChip" style="display:none">Invite: <b id="inviteName">—</b></span>
        </div>

        <div class="card-stack">
          <div class="swipe-card" id="swipeCard">
            <div class="overlay yes-overlay">COMING</div>
            <div class="overlay no-overlay">NOPE</div>
            
            <h1 id="question">Are you coming this week?</h1>
            <div class="subtitle" id="subtitle"></div>

            <div class="actions">
              <button class="yes" id="btnYes">I am coming</button>
              <button class="no" id="btnNo">I am not coming</button>
            </div>
          </div>
        </div>

        <div class="status" id="status"></div>
        <div class="subtitle" style="margin-top:24px;font-size:.88rem;opacity:0.7;text-align:center">
          Tip: Swipe right to accept, left to decline. Or try <b id="exampleLink"></b>
        </div>
      </section>

      <!-- ORGANISER VIEW -->
      <section class="view org" id="orgView">
        <div class="event-top">
          <div>
            <h1 id="orgTitle">Event · This Week</h1>
            <div class="subtitle">Live responses</div>
          </div>
          <div class="subtitle" id="orgMeta"></div>
        </div>
        <div class="stats">
          <div class="stat"><b id="cYes">0</b><br><span>Coming</span></div>
          <div class="stat"><b id="cNo">0</b><br><span>Not coming</span></div>
          <div class="stat"><b id="cWait">0</b><br><span>No response</span></div>
        </div>
        <table>
          <thead><tr><th>Invitee</th><th>Status</th><th>Updated</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>

        <div class="panel">
          <div>
            <h2>Invitees</h2>
            <div class="hint">Enter names (comma or newline separated). This creates a subscription list so “No response” becomes meaningful.</div>
            <textarea id="inviteesInput" placeholder="Anna&#10;Ben&#10;Chris"></textarea>
            <div class="row">
              <button class="btnSmall" id="saveInvitees">Save invitees</button>
              <button class="btnSmall" id="resetAll">Reset responses</button>
              <span class="hint" id="savedMsg" style="margin-left:auto"></span>
            </div>
          </div>

          <div>
            <h2>Links</h2>
            <div class="hint">Share the general invite link, or a named invite link that pre-fills identity.</div>
            <div class="linksBox" style="margin-top:10px">
              <code id="generalLink">—</code>
              <div class="row" style="margin-top:8px">
                <button class="btnSmall" id="copyGeneral">Copy general link</button>
              </div>
            </div>

            <div class="linksBox" style="margin-top:16px">
              <code id="namedLink">—</code>
              <div class="row" style="margin-top:8px">
                <button class="btnSmall" id="copyNamed">Copy named link</button>
                <span class="hint">Uses first invitee in list.</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // areyoucoming.to – demo with subscription list + named invite links (no backend)
  // Event = first path segment. Week = Monday-start key.
  // Store:
  //  - Invite list:   ayc.invites.{eventSlug} = ["Anna", ...]
  //  - Responses:     ayc.responses.{eventSlug}.{weekKey} = [{inviteKey, displayName, answer, ts}]
  // Sync across tabs with BroadcastChannel if available.

  const TZ = 'Europe/London';

  // Determine event slug:
  // 1. Check "?path=/slug" (GitHub Pages workaround)
  // 2. Fallback to first path segment of URL
  // 3. Default to "demo"
  const getEventSlug = () => {
    const params = new URLSearchParams(location.search);
    const pathParam = params.get('path');
    if (pathParam) {
      return pathParam.split('/').filter(Boolean)[0] || 'demo';
    }
    return location.pathname.split('/').filter(Boolean)[0] || 'demo';
  };
  const eventSlug = getEventSlug().toLowerCase();

  const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('ayc.sync') : null;

  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    t.style.animation = 'fadeIn 0.3s ease';
    clearTimeout(toast._t);
    toast._t = setTimeout(() => t.style.display='none', 2000);
  }

  function getMondayDate(){
    const d = new Date();
    const day = (d.getDay() + 6) % 7; // Monday=0
    d.setDate(d.getDate() - day);
    d.setHours(0,0,0,0);
    return d;
  }

  const mondayDate = getMondayDate();
  const weekKey = mondayDate.toISOString().slice(0,10);
  
  // Invites persist across weeks for the event
  const invitesKey = `ayc.invites.${eventSlug}`;
  // Responses are scoped to the specific week
  const responsesKey = `ayc.responses.${eventSlug}.${weekKey}`;

  const loadJSON = (k, fallback) => {
    try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(fallback)); } 
    catch { return fallback; }
  };
  const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  function normaliseName(s){
    return (s || '').trim().replace(/\s+/g,' ');
  }

  function inviteKeyFromName(name){
    return normaliseName(name).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  }

  function titleCaseKey(key){
    return (key || '').replace(/[-_]+/g,' ').replace(/\b\w/g, m => m.toUpperCase());
  }

  function parseInvitees(text){
    return (text || '')
      .split(/[\,\n]/g)
      .map(normaliseName)
      .filter(Boolean);
  }

  function formatWhen(ts){
    // Short format: "Mon 14:00"
    const d = new Date(ts);
    const now = new Date();
    const isToday = d.toDateString() === now.toDateString();
    return d.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', hour12:false });
  }

  function formatMonday(d){
    return d.toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'short' });
  }

  function upsertResponse(inviteKey, displayName, answer){
    const rows = loadJSON(responsesKey, []);
    const now = Date.now();
    const i = rows.findIndex(r => r.inviteKey === inviteKey);
    const payload = { inviteKey, displayName, answer, ts: now };
    if(i > -1) rows[i] = payload;
    else rows.push(payload);
    saveJSON(responsesKey, rows);
    if(bc) bc.postMessage({ type:'changed', eventSlug, weekKey });
    return rows;
  }

  function getResponseMap(){
    const rows = loadJSON(responsesKey, []);
    const m = new Map();
    for(const r of rows) m.set(r.inviteKey, r);
    return m;
  }

  function pill(answer){
    if(answer === 'yes') return '<span class="pill y">Coming</span>';
    if(answer === 'no') return '<span class="pill n">Not coming</span>';
    return '<span class="pill w">No response</span>';
  }

  function renderOrg(){
    const invites = loadJSON(invitesKey, []);
    const map = getResponseMap();

    let yes=0, no=0, wait=0;
    for(const name of invites){
      const ik = inviteKeyFromName(name);
      const r = map.get(ik);
      if(!r) wait++;
      else if(r.answer === 'yes') yes++;
      else if(r.answer === 'no') no++;
    }

    document.getElementById('cYes').textContent = String(yes);
    document.getElementById('cNo').textContent = String(no);
    document.getElementById('cWait').textContent = String(wait);

    const tb = document.getElementById('rows');
    tb.innerHTML = '';

    if(invites.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3"><div class="empty-state">No invitees yet.<br>Add names below to track responses.</div></td>`;
      tb.appendChild(tr);
      return;
    }

    for(const name of invites){
      const ik = inviteKeyFromName(name);
      const r = map.get(ik);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>${name}</b></td>
        <td>${pill(r && r.answer)}</td>
        <td style="color:var(--muted)">${r ? formatWhen(r.ts) : '—'}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function setLinks(){
    const base = new URL(location.href);
    base.search = '';
    base.hash = '';

    const general = base.toString();
    document.getElementById('generalLink').textContent = general;

    const invites = loadJSON(invitesKey, []);
    const first = invites[0] || 'Anna';
    const named = new URL(general);
    named.searchParams.set('invite', inviteKeyFromName(first));
    document.getElementById('namedLink').textContent = named.toString();

    const ex = new URL(general);
    ex.searchParams.set('invite', 'anna');
    const span = document.getElementById('exampleLink');
    span.innerHTML = `<a href="${ex.toString()}">${ex.pathname}?invite=anna</a>`;
  }

  function syncInviteeFromUrl(){
    const url = new URL(location.href);
    const invite = url.searchParams.get('invite');
    const input = document.getElementById('nameInput');
    const chip = document.getElementById('inviteChip');
    const chipName = document.getElementById('inviteName');

    if(invite){
      const invites = loadJSON(invitesKey, []);
      const match = invites.find(n => inviteKeyFromName(n) === invite);
      const display = match || titleCaseKey(invite);

      input.value = display;
      input.setAttribute('data-invitekey', invite);
      input.disabled = true;

      chip.style.display = 'inline-flex';
      chipName.textContent = invite;
    } else {
      input.disabled = false;
      input.removeAttribute('data-invitekey');
      chip.style.display = 'none';
    }
  }

  function currentInviteKey(){
    const input = document.getElementById('nameInput');
    const fromUrl = input.getAttribute('data-invitekey');
    if(fromUrl) return fromUrl;

    const name = normaliseName(input.value);
    if(!name) return '';
    return inviteKeyFromName(name);
  }

  function ensureInInviteList(name){
    const invites = loadJSON(invitesKey, []);
    const norm = normaliseName(name).toLowerCase();
    if(invites.some(n => normaliseName(n).toLowerCase() === norm)) return;
    invites.push(name);
    saveJSON(invitesKey, invites);
  }

  function renderInviteeStatus(justSaved = false){
    const inviteKey = currentInviteKey();
    const status = document.getElementById('status');
    status.className = 'status';

    if(!inviteKey){ status.textContent=''; return; }
    const map = getResponseMap();
    const r = map.get(inviteKey);
    if(!r){ status.textContent=''; return; }

    status.innerHTML = (r.answer === 'yes') 
      ? `<span>✓</span> You are coming.` 
      : `<span>×</span> You are not coming.`;
    
    if(justSaved) status.classList.add('saved');
  }

  // Init text
  const pretty = titleCaseKey(eventSlug);
  const prettyDate = formatMonday(mondayDate);
  document.getElementById('question').textContent = `Are you coming this week?`;
  document.getElementById('subtitle').textContent = `${prettyDate}`;
  document.getElementById('orgTitle').textContent = `${pretty} · ${prettyDate}`;
  document.getElementById('orgMeta').textContent = `/${eventSlug} · week ${weekKey}`;

  // Prefill invitees input
  const invitesInitial = loadJSON(invitesKey, []);
  document.getElementById('inviteesInput').value = invitesInitial.join('\n');
  
  // Invitee actions & Swipe Logic
  const nameInput = document.getElementById('nameInput');
  const card = document.getElementById('swipeCard');
  let isDragging = false;
  let startX = 0;
  let currentX = 0;

  function initSwipe() {
    const startDrag = (x) => {
      isDragging = true;
      startX = x;
      card.classList.remove('animating');
    };

    const moveDrag = (x) => {
      if(!isDragging) return;
      currentX = x - startX;
      
      const rotate = currentX / 20;
      card.style.transform = `translate(${currentX}px, ${Math.abs(currentX)/10}px) rotate(${rotate}deg)`;

      // Overlays
      const yesOp = Math.max(0, currentX / 100);
      const noOp = Math.max(0, -currentX / 100);
      document.querySelector('.yes-overlay').style.opacity = Math.min(1, yesOp);
      document.querySelector('.no-overlay').style.opacity = Math.min(1, noOp);
    };

    const endDrag = () => {
      if(!isDragging) return;
      isDragging = false;
      card.classList.add('animating');

      // Threshold to trigger
      if (currentX > 100) {
        // Yes
        card.style.transform = `translate(150%, 50px) rotate(20deg)`;
        setTimeout(() => { handleResponse('yes'); resetCard(); }, 250);
      } else if (currentX < -100) {
        // No
        card.style.transform = `translate(-150%, 50px) rotate(-20deg)`;
        setTimeout(() => { handleResponse('no'); resetCard(); }, 250);
      } else {
        // Reset
        resetCard();
      }
    };

    const resetCard = () => {
      card.style.transform = '';
      document.querySelector('.yes-overlay').style.opacity = '0';
      document.querySelector('.no-overlay').style.opacity = '0';
    };

    // Touch
    card.addEventListener('touchstart', e => startDrag(e.touches[0].clientX));
    card.addEventListener('touchmove', e => {
      // Prevent scrolling while swiping
      if(isDragging) e.preventDefault();
      moveDrag(e.touches[0].clientX);
    });
    card.addEventListener('touchend', endDrag);

    // Mouse
    card.addEventListener('mousedown', e => {
      if(e.target.tagName === 'BUTTON') return; // Let buttons work
      startDrag(e.clientX);
    });
    window.addEventListener('mousemove', e => {
      if(isDragging) {
        e.preventDefault();
        moveDrag(e.clientX);
      }
    });
    window.addEventListener('mouseup', endDrag);
  }

  function handleResponse(answer) {
    const name = normaliseName(nameInput.value);
    if(!name) {
      nameInput.focus();
      return alert('Please enter your name');
    }

    const ik = currentInviteKey();
    if(!ik) return alert('Please enter your name');

    ensureInInviteList(name);
    upsertResponse(ik, name, answer);
    
    renderInviteeStatus(true); // pass true to trigger animation
    renderOrg();
  }

  document.getElementById('btnYes').onclick = () => handleResponse('yes');
  document.getElementById('btnNo').onclick = () => handleResponse('no');
  
  // Initial render
  syncInviteeFromUrl();
  setLinks();
  renderOrg();
  renderInviteeStatus();
  initSwipe();

  // Organiser actions
  document.getElementById('saveInvitees').onclick = () => {
    const raw = document.getElementById('inviteesInput').value;
    const names = parseInvitees(raw);
    saveJSON(invitesKey, names);

    const msg = document.getElementById('savedMsg');
    msg.textContent = names.length ? `Saved.` : 'Saved.';
    msg.style.opacity = '1';
    setTimeout(() => msg.style.opacity = '0', 2000);

    if(bc) bc.postMessage({ type:'changed', eventSlug, weekKey });
    setLinks();
    renderOrg();
    syncInviteeFromUrl();
  };

  document.getElementById('resetAll').onclick = () => {
    if(!confirm('Reset responses for this week? (Invites will be kept)')) return;
    localStorage.removeItem(responsesKey);
    syncInviteeFromUrl();
    setLinks();
    renderOrg();
    document.getElementById('status').textContent = '';
    toast('Responses cleared.');
    if(bc) bc.postMessage({ type:'changed', eventSlug, weekKey });
  };

  // Copy link actions
  document.getElementById('copyGeneral').onclick = async () => {
    await copyText(document.getElementById('generalLink').textContent);
  };
  document.getElementById('copyNamed').onclick = async () => {
    await copyText(document.getElementById('namedLink').textContent);
  };

  async function copyText(text){
    try{ await navigator.clipboard.writeText(text); toast('Copied.'); } 
    catch{ prompt('Copy this link:', text); }
  }

  // Nav
  const iv = document.getElementById('inviteeView');
  const ov = document.getElementById('orgView');
  document.getElementById('navInvitee').onclick = (e) => {
    e.preventDefault();
    iv.classList.add('active');
    ov.classList.remove('active');
    syncInviteeFromUrl();
    renderInviteeStatus();
  };
  document.getElementById('navOrg').onclick = (e) => {
    e.preventDefault();
    ov.classList.add('active');
    iv.classList.remove('active');
    renderOrg();
  };

  // Live sync across tabs
  function refreshAll(){
    document.getElementById('inviteesInput').value = loadJSON(invitesKey, []).join('\n');
    setLinks();
    renderOrg();
    syncInviteeFromUrl();
    renderInviteeStatus();
  }

  if(bc){
    bc.onmessage = (ev) => {
      const msg = ev.data || {};
      if(msg.type === 'changed' && msg.eventSlug === eventSlug && msg.weekKey === weekKey){
        refreshAll();
      }
    };
  }

  window.addEventListener('storage', (ev) => {
    if(ev.key === invitesKey || ev.key === responsesKey) refreshAll();
  });

  window.addEventListener('popstate', () => {
    syncInviteeFromUrl();
    renderInviteeStatus();
  });
</script>
</body>
</html>